/*!
 * angular-ui-validate
 * https://github.com/angular-ui/ui-validate
 * Version: 1.2.3 - 2017-05-18T08:07:23.042Z
 * License: MIT
 */
!function(){"use strict";angular.module("ui.validate",[]).directive("uiValidate",["$$uiValidateApplyWatch","$$uiValidateApplyWatchCollection",function(a,i){return{restrict:"A",require:"ngModel",link:function(t,n,l,e){var u,c=t.$eval(l.uiValidate);c&&(angular.isString(c)&&(c={validator:c}),angular.forEach(c,function(a,i){u=function(n,l){var u=t.$eval(a,{$value:n,$modelValue:n,$viewValue:l,$name:e.$name});return angular.isObject(u)&&angular.isFunction(u.then)?(u.then(function(){e.$setValidity(i,!0)},function(){e.$setValidity(i,!1)}),!0):!!u},e.$validators[i]=u}),l.uiValidateWatch&&a(t,e,t.$eval(l.uiValidateWatch),l.uiValidateWatchObjectEquality),l.uiValidateWatchCollection&&i(t,e,t.$eval(l.uiValidateWatchCollection)))}}}]).directive("uiValidateAsync",["$$uiValidateApplyWatch","$$uiValidateApplyWatchCollection","$timeout","$q",function(a,i,t,n){return{restrict:"A",require:"ngModel",link:function(t,l,e,u){var c,r=t.$eval(e.uiValidateAsync);r&&(angular.isString(r)&&(r={validatorAsync:r}),angular.forEach(r,function(a,i){c=function(i,l){var e=t.$eval(a,{$value:i,$modelValue:i,$viewValue:l,$name:u.$name});return angular.isObject(e)&&angular.isFunction(e.then)?e:n(function(a,i){setTimeout(function(){e?a():i()},0)})},u.$asyncValidators[i]=c}),e.uiValidateWatch&&a(t,u,t.$eval(e.uiValidateWatch),e.uiValidateWatchObjectEquality),e.uiValidateWatchCollection&&i(t,u,t.$eval(e.uiValidateWatchCollection)))}}}]).service("$$uiValidateApplyWatch",function(){return function(a,i,t,n){var l=function(){i.$validate()};angular.isString(t)?a.$watch(t,l,n):angular.isArray(t)?angular.forEach(t,function(i){a.$watch(i,l,n)}):angular.isObject(t)&&angular.forEach(t,function(i){angular.isString(i)&&a.$watch(i,l,n),angular.isArray(i)&&angular.forEach(i,function(i){a.$watch(i,l,n)})})}}).service("$$uiValidateApplyWatchCollection",function(){return function(a,i,t){var n=function(){i.$validate()};angular.isString(t)?a.$watchCollection(t,n):angular.isArray(t)?angular.forEach(t,function(i){a.$watchCollection(i,n)}):angular.isObject(t)&&angular.forEach(t,function(i){angular.isString(i)&&a.$watchCollection(i,n),angular.isArray(i)&&angular.forEach(i,function(i){a.$watchCollection(i,n)})})}})}();
/*!
 * angular-ui-mask
 * https://github.com/angular-ui/ui-mask
 * Version: 1.8.7 - 2016-07-26T16:01:23.393Z
 * License: MIT
 */
!function(){"use strict";angular.module("ui.mask",[]).value("uiMaskConfig",{maskDefinitions:{9:/\d/,A:/[a-zA-Z]/,"*":/[a-zA-Z0-9]/},clearOnBlur:!0,clearOnBlurPlaceholder:!1,escChar:"\\",eventsToHandle:["input","keyup","click","focus"],addDefaultPlaceholder:!0,allowInvalidValue:!1}).provider("uiMask.Config",function(){var e={};this.maskDefinitions=function(n){return e.maskDefinitions=n},this.clearOnBlur=function(n){return e.clearOnBlur=n},this.clearOnBlurPlaceholder=function(n){return e.clearOnBlurPlaceholder=n},this.eventsToHandle=function(n){return e.eventsToHandle=n},this.addDefaultPlaceholder=function(n){return e.addDefaultPlaceholder=n},this.allowInvalidValue=function(n){return e.allowInvalidValue=n},this.$get=["uiMaskConfig",function(n){var t=n;for(var a in e)angular.isObject(e[a])&&!angular.isArray(e[a])?angular.extend(t[a],e[a]):t[a]=e[a];return t}]}).directive("uiMask",["uiMask.Config",function(e){function n(e){return e===document.activeElement&&(!document.hasFocus||document.hasFocus())&&!!(e.type||e.href||~e.tabIndex)}return{priority:100,require:"ngModel",restrict:"A",compile:function(){var t=angular.copy(e);return function(e,a,i,r){function l(e){return angular.isDefined(e)?(w(e),L?(h(),d(),!0):f()):f()}function u(e){e&&(B=e,!L||0===a.val().length&&angular.isDefined(i.placeholder)||a.val(m(p(a.val()))))}function o(){return l(i.uiMask)}function c(e){return L?(j=p(e||""),R=g(j),r.$setValidity("mask",R),j.length&&(R||Q.allowInvalidValue)?m(j):void 0):e}function s(e){return L?(j=p(e||""),R=g(j),r.$viewValue=j.length?m(j):"",r.$setValidity("mask",R),R||Q.allowInvalidValue?J?r.$viewValue:j:void 0):e}function f(){return L=!1,v(),angular.isDefined(q)?a.attr("placeholder",q):a.removeAttr("placeholder"),angular.isDefined(W)?a.attr("maxlength",W):a.removeAttr("maxlength"),a.val(r.$modelValue),r.$viewValue=r.$modelValue,!1}function h(){j=F=p(r.$modelValue||""),H=_=m(j),R=g(j),i.maxlength&&a.attr("maxlength",2*S[S.length-1]),!q&&Q.addDefaultPlaceholder&&a.attr("placeholder",B);for(var e=r.$modelValue,n=r.$formatters.length;n--;)e=r.$formatters[n](e);r.$viewValue=e||"",r.$render()}function d(){Z||(a.bind("blur",$),a.bind("mousedown mouseup",V),a.bind("keydown",E),a.bind(Q.eventsToHandle.join(" "),O),Z=!0)}function v(){Z&&(a.unbind("blur",$),a.unbind("mousedown",V),a.unbind("mouseup",V),a.unbind("keydown",E),a.unbind("input",O),a.unbind("keyup",O),a.unbind("click",O),a.unbind("focus",O),Z=!1)}function g(e){return e.length?e.length>=T:!0}function p(e){var n,t,i="",r=a[0],l=A.slice(),u=N,o=u+C(r),c="";return e=e.toString(),n=0,t=e.length-B.length,angular.forEach(I,function(a){var i=a.position;i>=u&&o>i||(i>=u&&(i+=t),e.substring(i,i+a.value.length)===a.value&&(c+=e.slice(n,i),n=i+a.value.length))}),e=c+e.slice(n),angular.forEach(e.split(""),function(e){l.length&&l[0].test(e)&&(i+=e,l.shift())}),i}function m(e){var n="",t=S.slice();return angular.forEach(B.split(""),function(a,i){e.length&&i===t[0]?(n+=e.charAt(0)||"_",e=e.substr(1),t.shift()):n+=a}),n}function b(e){var n,t=angular.isDefined(i.uiMaskPlaceholder)?i.uiMaskPlaceholder:i.placeholder;return angular.isDefined(t)&&t[e]?t[e]:(n=angular.isDefined(i.uiMaskPlaceholderChar)&&i.uiMaskPlaceholderChar?i.uiMaskPlaceholderChar:"_","space"===n.toLowerCase()?" ":n[0])}function k(){var e,n,t=B.split("");S&&!isNaN(S[0])&&angular.forEach(S,function(e){t[e]="_"}),e=t.join(""),n=e.replace(/[_]+/g,"_").split("_"),n=n.filter(function(e){return""!==e});var a=0;return n.map(function(n){var t=e.indexOf(n,a);return a=t+1,{value:n,position:t}})}function w(e){var n=0;if(S=[],A=[],B="",angular.isString(e)){T=0;var t=!1,a=0,i=e.split(""),r=!1;angular.forEach(i,function(e,i){r?(r=!1,B+=e,n++):Q.escChar===e?r=!0:Q.maskDefinitions[e]?(S.push(n),B+=b(i-a),A.push(Q.maskDefinitions[e]),n++,t||T++,t=!1):"?"===e?(t=!0,a++):(B+=e,n++)})}S.push(S.slice().pop()+1),I=k(),L=S.length>1?!0:!1}function $(){if((Q.clearOnBlur||Q.clearOnBlurPlaceholder&&0===j.length&&i.placeholder)&&(N=0,z=0,R&&0!==j.length||(H="",a.val(""),e.$apply(function(){r.$pristine||r.$setViewValue("")}))),j!==U){var n=a.val(),t=""===j&&n&&angular.isDefined(i.uiMaskPlaceholderChar)&&"space"===i.uiMaskPlaceholderChar;t&&a.val(""),y(a[0]),t&&a.val(n)}U=j}function y(e){var n;angular.isFunction(window.Event)&&!e.fireEvent?(n=new Event("change",{view:window,bubbles:!0,cancelable:!1}),e.dispatchEvent(n)):"createEvent"in document?(n=document.createEvent("HTMLEvents"),n.initEvent("change",!1,!0),e.dispatchEvent(n)):e.fireEvent&&e.fireEvent("onchange")}function V(e){"mousedown"===e.type?a.bind("mouseout",M):a.unbind("mouseout",M)}function M(){z=C(this),a.unbind("mouseout",M)}function E(e){var n=8===e.which,t=P(this)-1||0,i=90===e.which&&e.ctrlKey;if(n){for(;t>=0;){if(D(t)){x(this,t+1);break}t--}K=-1===t}i&&(a.val(""),e.preventDefault())}function O(n){n=n||{};var t=n.which,i=n.type;if(16!==t&&91!==t){var l,u=a.val(),o=_,c=!1,s=p(u),f=F,h=P(this)||0,d=N||0,v=h-d,g=S[0],b=S[s.length]||S.slice().shift(),k=z||0,w=C(this)>0,$=k>0,y=u.length>o.length||k&&u.length>o.length-k,V=u.length<o.length||k&&u.length===o.length-k,M=t>=37&&40>=t&&n.shiftKey,E=37===t,O=8===t||"keyup"!==i&&V&&-1===v,A=46===t||"keyup"!==i&&V&&0===v&&!$,I=(E||O||"click"===i)&&h>g;if(z=C(this),!M&&(!w||"click"!==i&&"keyup"!==i&&"focus"!==i)){if(O&&K)return a.val(B),e.$apply(function(){r.$setViewValue("")}),void x(this,d);if("input"===i&&V&&!$&&s===f){for(;O&&h>g&&!D(h);)h--;for(;A&&b>h&&-1===S.indexOf(h);)h++;var T=S.indexOf(h);s=s.substring(0,T)+s.substring(T+1),s!==f&&(c=!0)}for(l=m(s),_=l,F=s,!c&&u.length>l.length&&(c=!0),a.val(l),c&&e.$apply(function(){r.$setViewValue(l)}),y&&g>=h&&(h=g+1),I&&h--,h=h>b?b:g>h?g:h;!D(h)&&h>g&&b>h;)h+=I?-1:1;(I&&b>h||y&&!D(d))&&h++,N=h,x(this,h)}}}function D(e){return S.indexOf(e)>-1}function P(e){if(!e)return 0;if(void 0!==e.selectionStart)return e.selectionStart;if(document.selection&&n(a[0])){e.focus();var t=document.selection.createRange();return t.moveStart("character",e.value?-e.value.length:0),t.text.length}return 0}function x(e,t){if(!e)return 0;if(0!==e.offsetWidth&&0!==e.offsetHeight)if(e.setSelectionRange)n(a[0])&&(e.focus(),e.setSelectionRange(t,t));else if(e.createTextRange){var i=e.createTextRange();i.collapse(!0),i.moveEnd("character",t),i.moveStart("character",t),i.select()}}function C(e){return e?void 0!==e.selectionStart?e.selectionEnd-e.selectionStart:window.getSelection?window.getSelection().toString().length:document.selection?document.selection.createRange().text.length:0:0}var S,A,B,I,T,j,H,R,_,F,N,z,K,L=!1,Z=!1,q=i.placeholder,W=i.maxlength,G=r.$isEmpty;r.$isEmpty=function(e){return G(L?p(e||""):e)};var J=!1;i.$observe("modelViewValue",function(e){"true"===e&&(J=!0)}),i.$observe("allowInvalidValue",function(e){Q.allowInvalidValue=""===e?!0:!!e,c(r.$modelValue)});var Q={};i.uiOptions?(Q=e.$eval("["+i.uiOptions+"]"),Q=angular.isObject(Q[0])?function(e,n){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(void 0===n[t]?n[t]=angular.copy(e[t]):angular.isObject(n[t])&&!angular.isArray(n[t])&&(n[t]=angular.extend({},e[t],n[t])));return n}(t,Q[0]):t):Q=t,i.$observe("uiMask",l),angular.isDefined(i.uiMaskPlaceholder)?i.$observe("uiMaskPlaceholder",u):i.$observe("placeholder",u),angular.isDefined(i.uiMaskPlaceholderChar)&&i.$observe("uiMaskPlaceholderChar",o),r.$formatters.unshift(c),r.$parsers.unshift(s);var U=a.val();a.bind("mousedown mouseup",V),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){if(null===this)throw new TypeError;var n=Object(this),t=n.length>>>0;if(0===t)return-1;var a=0;if(arguments.length>1&&(a=Number(arguments[1]),a!==a?a=0:0!==a&&a!==1/0&&a!==-(1/0)&&(a=(a>0||-1)*Math.floor(Math.abs(a)))),a>=t)return-1;for(var i=a>=0?a:Math.max(t-Math.abs(a),0);t>i;i++)if(i in n&&n[i]===e)return i;return-1})}}}}])}();
var app = angular.module('app',['ui.router','ui.router.state.events', 'ui.validate', 'ui.mask', 'ngStorage'])
.run(function ($rootScope, $state,AuthService) {
  $rootScope.$on('$stateChangeStart', function(event, toState, toParams) {
    if (!AuthService.isAuthenticated() && toState.authorize) {      
        $rootScope.toState = toState.name;
        $rootScope.toStateParams = toParams;
        event.preventDefault();
        $state.go('app.public.login');
    }
  });

})
.directive('menuLateral', function() {
  return {
      restrict: 'E',
      scope: {
          items: '@',
          acao: '&'
      },
      templateUrl: '/app/views/templates/menu-lateral.html'
  };
});

(function  () {
    angular.module('app')
      .constant('appSettings', {
        uri : 'https://apiestoqueando.herokuapp.com',
        apiUrl : '/api/',
        authUrl : '/auth/',
      });
  })();
   

(function  () {

    angular.module('app')
      .factory('AuthHttpInterceptor', AuthHttpInterceptor);
  
    AuthHttpInterceptor.$inject = ['TokenHandler','$q', '$state'];
  
    function AuthHttpInterceptor(TokenHandler, $q, $state) {
  
      function request(config) {
        config.headers = config.headers || {};

        if (TokenHandler.get()) {          
          config.headers['Authorization'] = 'Bearer ' + TokenHandler.get();
        }  
        return config;     
      }  

      function responseError(rejection) {
        if (rejection.status === 403 || rejection.status === 401) {
          $state.go('app.public.login');
        }
        return rejection;
      }
      return {
        request : request,
        responseError: responseError
      }
    };
  
    angular.module('app')
      .config(httpConfig);
  
    httpConfig.$inject = ['$httpProvider'];
  
    function httpConfig($httpProvider) {
      $httpProvider.interceptors.push('AuthHttpInterceptor');
    }
  
  })();
  
app.factory('AuthService', function(appSettings, $http, $q, $timeout, $state, $location, TokenHandler)
{
  function login(credentials) {
    var defeered = $q.defer();
    $http.post(appSettings.uri + '/authenticate', {'accessData': credentials })
        .then(function (response) { 
            TokenHandler.set(response.data.token);
            defeered.resolve();
        })
        .catch(defeered.reject);

    return defeered.promise;
  }

function isAuthenticated() {
    return TokenHandler.get();
}

function authorize(url) {  
$timeout(function () {
  $state.go('app.public.login')
  if (url) {
    $location.search({redirect : url});
  } 
});
}

return {
    login : login,
    isAuthenticated : isAuthenticated,
    authorize : authorize
}
});

app.factory('TokenHandler', function($window){
  var _token = null;
  
  function getToken() {
    if ($window.sessionStorage.getItem("token")){
      return $window.sessionStorage.getItem("token")
    } else{
      return _token;
    }
  }

  function setToken(token) {
    _token = token;
    $window.sessionStorage.setItem('token', token);
  }

  return {
    get: getToken,
    set: setToken
  };
})

app.config(function($stateProvider, $urlRouterProvider, $locationProvider){
  $urlRouterProvider.otherwise('/');

  $stateProvider

    .state('app', {
      abstract: true
    })
    //rotas públicas
    .state('app.public', {
      abstract: true
    })
    .state('app.public.home', {
      url: '/',
      templateUrl: 'app/views/home.html',
      controller: 'HomeController'
    })
    .state('app.public.register', {
      url: '/register',
      templateUrl: 'app/views/register/register.html',
      controller: 'RegisterController'
    })
    .state('app.public.login', {
      url: '/login',
      templateUrl: 'app/views/login/login.html',
      controller: 'LoginController'
    })
    // rotas privadas
    .state('app.private', {
      abstract: true
    })
    .state('app.private.welcome', {
      url: '/welcome',
      templateUrl: 'app/views/application/welcome.html',
      controller: 'WelcomeController',
      authorize: true
    })
    .state('app.private.vitrine', {
      url: '/vitrine',
      templateUrl: 'app/views/application/shop-window.html',
      controller: 'ShopViewController',
      authorize: true

    });

    // Utilizando o HTML5 History API
    $locationProvider.html5Mode({
      enabled: false,
      requireBase: false
    });
  })
/*
app.config(function($routeProvider, $locationProvider)
{
    $locationProvider.html5Mode({
        enabled: true,
        requireBase: false
      });

    $routeProvider.when('/', {
       templateUrl : 'app/views/home.html',
       controller  : 'HomeController',
    })
    $routeProvider.when('/register', {
       templateUrl : 'app/views/register/register.html',
       controller  : 'RegisterController',
    })
    $routeProvider.when('/login', {
      templateUrl : 'app/views/login/login.html',
      controller  : 'LoginController',
    })
    $routeProvider.when('/welcome',{
      templateUrl : 'app/views/application/welcome.html',
      controller  : 'WelcomeController',
      authorize: true
    })
    $routeProvider.when('/vitrine',{
      templateUrl : 'app/views/application/shop-window.html',
      controller  : 'ShopWindowController',
      authorize: true
    })
   .otherwise ({ redirectTo: '/' });
});*/
app.controller('HomeController', function($rootScope, $scope, $location, $http, appSettings)
{
   
   
});
app.controller('ShopWindowController', function($rootScope, $scope, $http, appSettings, $q )
{
    $scope.getProducts = function() {        
        $http.get(appSettings.uri + '/product').success(function(data){
          console.log(data)
        });              
    }()

});
app.controller('WelcomeController', function($rootScope, $scope, $http, appSettings, $q, $window )
{
    console.log($window.sessionStorage.getItem("user"))
    if($window.sessionStorage.getItem("user")){
        $rootScope.user = $window.sessionStorage.getItem("user");
    }
    $scope.getProducts = function() {        
        $http.get(appSettings.uri + '/product').success(function(data){
            $scope.products = data;
        });              
    }()
});
app.controller('LoginController', function($rootScope, $scope, $location, AuthService, $state, $window)
{
  $scope.accessData = {};
  $scope.login = function(){
    $scope.loading = true;
    $scope.success = false;
    AuthService.login($scope.accessData)
    .then(function (data) {
      if ($location.search().redirect) {
        $state.go('home');
      }
      $window.sessionStorage.setItem('user', $scope.accessData.email);
      $state.go('app.private.welcome');
    })
    .catch(function (err) {
      $scope.loading = false;
      $scope.success = false;
      $state.go('home');

    });
  }
 


});

app.controller('RegisterController', function($rootScope, $scope, $http, appSettings)
{
    $scope.personData = {};
    $scope.cpfValidate = function(strCPF) {
        var soma;
        var resto;
        soma = 0;
      
      if(angular.isDefined(strCPF)){  
      if (strCPF == "00000000000" || strCPF == "11111111111" || strCPF == "22222222222" || strCPF == "33333333333" 
      || strCPF == "44444444444" || strCPF == "55555555555" || strCPF == "66666666666" || strCPF == "77777777777" 
      || strCPF == "88888888888" || strCPF == "99999999999") {          
          return false;
      }

      for (i=1; i<=9; i++) soma = soma + parseInt(strCPF.substring(i-1, i)) * (11 - i);
      resto = (soma * 10) % 11;
       
        if ((resto == 10) || (resto == 11))  resto = 0;
        if (resto != parseInt(strCPF.substring(9, 10)) ) return false;
       
      soma = 0;
        for (i = 1; i <= 10; i++) soma = soma + parseInt(strCPF.substring(i-1, i)) * (12 - i);
        resto = (soma * 10) % 11;
       
        if ((resto == 10) || (resto == 11))  resto = 0;
        if (resto != parseInt(strCPF.substring(10, 11) ) ) return false;
        return true;
      }
      else{
          return false;
      }
    } 

    $scope.hasSurname = function(input) {
        if(input) {
            var aux = input.split(" ");
            if(aux.length > 1){
                return true;
            }
            return false;
        }
        return false;
    }
  
$scope.addConsultant = function() {
    $scope.loading = true;
    $scope.success = false;
  
    $http.post( appSettings.uri+ '/public/createPerson',{'personData': $scope.personData }, 
    {
        headers: {'Content-Type': 'application/json'} 
    })
    .success(function (data, status, headers, config) {
        $scope.loading = false;
        $scope.success = true;  
    })
    .error(function (data, status, header, config) {
        $scope.loading = false;
        $scope.success = false;
    });
  
    }


});
app.filter('cpf', function() {
  return function(strCPF) {
    strCPF=strCPF.replace(/\D/g,"")
	strCPF=strCPF.replace(/(\d{3})(\d)/,"$1.$2")
	strCPF=strCPF.replace(/(\d{3})(\d)/,"$1.$2")
	strCPF=strCPF.replace(/(\d{3})(\d{1,2})$/,"$1-$2")
	return strCPF
  };
})
app.filter('case', function() {
    return function(input, uppercase) {
        var out = "";
        if ( uppercase ) {
            out = input.toUpperCase();
        } else {
            out = input.toLowerCase();
        }
        return out;
    };
});